<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-War Standoff: The Race for Territory (1945)</title>
    <link rel="icon" href="favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
    <link rel="shortcut icon" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            position: relative;
        }
        
        /* Fixed background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(0, 76, 153, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 102, 204, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Custom colors matching the main page's NHD theme */
        .nhd-blue { background-color: #004c99; }
        .text-nhd-blue { color: #004c99; }
        .border-nhd-blue { border-color: #004c99; }
        .nhd-light-blue { background-color: #e6f0ff; }
        .nhd-gold { background-color: #ffc72c; }
        .hover\:bg-nhd-blue\/90:hover { background-color: rgba(0, 76, 153, 0.9); }

        /* Style for loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #004c99;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced card container */
        .card-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 76, 153, 0.15);
            border-radius: 28px;
            box-shadow: 0 30px 70px rgba(0, 76, 153, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        
        .card-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0, 76, 153, 0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Back button enhancement */
        .back-button {
            transition: all 0.3s ease;
            color: #004c99;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            background: rgba(0, 76, 153, 0.05);
        }
        
        .back-button:hover {
            color: #0066cc;
            background: rgba(0, 76, 153, 0.12);
            transform: translateX(-6px);
            box-shadow: 0 4px 12px rgba(0, 76, 153, 0.15);
        }
        
        /* Heading styles */
        h1 {
            background: linear-gradient(135deg, #004c99 0%, #0066cc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            font-size: 2rem;
            font-weight: 900;
            line-height: 1.2;
            position: relative;
            z-index: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }
        
        @media (min-width: 640px) {
            h1 { font-size: 2.5rem; }
        }
        
        @media (min-width: 768px) {
            h1 { font-size: 3rem; }
        }
        
        /* Header container */
        .mt-8 h1 {
            display: block;
            width: 100%;
        }
        
        h2 {
            border-left: 5px solid #004c99;
            padding-left: 16px;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            font-weight: 800;
            color: #1a3a52;
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        
        h2:hover {
            border-left-color: #0066cc;
            padding-left: 20px;
            transform: translateX(4px);
        }
        
        h3 {
            color: #004c99;
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        /* Content box styling */
        .content-box {
            background: linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);
            border: 2px solid rgba(0, 76, 153, 0.15);
            border-radius: 18px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .content-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }
        
        .content-box:hover::before {
            left: 100%;
        }
        
        .content-box:hover {
            border-color: rgba(0, 76, 153, 0.35);
            box-shadow: 0 15px 40px rgba(0, 76, 153, 0.15);
            transform: translateY(-4px);
        }
        
        /* List item styling */
        ul li {
            transition: all 0.2s ease;
            padding: 0.5rem 0;
            position: relative;
            padding-left: 0.5rem;
        }
        
        ul li:hover {
            color: #004c99;
            padding-left: 1rem;
        }
        
        ul li strong {
            color: #004c99;
            font-weight: 700;
        }
        
        /* Link styling */
        a {
            color: #004c99;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }
        
        a:hover {
            color: #0066cc;
        }
        
        a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #004c99, #0066cc);
            transition: width 0.3s ease;
        }
        
        a:hover::after {
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen py-8 sm:py-12 px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16">
    <nav class="top-nav flex items-center justify-between py-4 px-4 sm:px-6 md:px-8" aria-label="Main navigation">
        <span class="text-sm sm:text-base font-extrabold text-nhd-blue tracking-tight">Chinese Civil War (1945–1949)</span>
        <div class="flex items-center space-x-4 sm:space-x-6 text-sm sm:text-base">
            <a href="index.html#timeline" class="hover:text-blue-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-nhd-blue">Timeline</a>
            <a href="index.html#comparison" class="hover:text-blue-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-nhd-blue">Comparison</a>
            <a href="summary.html" class="hover:text-blue-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-nhd-blue">Summary</a>
            <a href="sources.html" class="hover:text-blue-700 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-nhd-blue">Sources</a>
        </div>
    </nav>

    <div class="card-container bg-white p-8 sm:p-12 w-full max-w-6xl mx-auto" role="main">
        <a href="#main-content" class="sr-only focus:not-sr-only focus:block focus:p-2 focus:bg-nhd-blue focus:text-white focus:rounded focus:outline-2 focus:outline-offset-2 focus:outline-nhd-blue">Skip to main content</a>
        
        <a href="index.html" 
            class="back-button inline-flex items-center text-sm font-bold hover:text-blue-800 transition duration-150 group focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-nhd-blue">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform duration-200">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Back to Timeline
        </a>

        <div id="main-content" class="mt-8 border-b-2 border-nhd-blue/20 pb-6" aria-label="Page header">
            <h1 class="text-4xl sm:text-5xl font-extrabold leading-tight">Post-War Standoff: The Race for Territory (1945)</h1>
            <p class="mt-3 text-gray-600 text-lg leading-relaxed max-w-2xl">After Japan surrendered, the uneasy truce between the Nationalists (KMT) and Communists (CCP) collapsed almost overnight, and both sides rushed to grab the land, weapons, and cities Japan left behind.</p>
        </div>

        <div class="mt-10 space-y-8">
            <div class="content-box p-7 nhd-light-blue rounded-xl border border-nhd-blue/50">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Why Manchuria Mattered</h2>
                <p class="text-gray-700 leading-relaxed">
                    Manchuria, rich in factories and railways, became the main prize. U.S. planes and ships flew KMT troops into major coastal cities, while CCP forces moved quickly into the countryside and toward Manchurian rail lines. As Soviet troops withdrew, Communist units gained access to large piles of surrendered Japanese weapons, helping them close the firepower gap.
                </p>
            </div>

            <div class="content-box p-7 bg-white rounded-xl border border-nhd-blue/30">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Cities vs. Countryside</h2>
                <p class="text-gray-700 leading-relaxed">
                    The KMT focused on seizing big cities and ports such as Beijing, Tianjin, and Shanghai. The CCP focused on villages, railways, and the spaces in between. Nationalist columns depended on long, fragile rail lines; Communist units blew up tracks and bridges, isolating garrisons and turning early KMT gains into future problems.
                </p>
            </div>

            <div class="content-box p-7 nhd-light-blue rounded-xl border border-nhd-blue/50">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">From Ceasefire to Civil War</h2>
                <p class="text-gray-700 leading-relaxed">
                    U.S. envoy George Marshall tried to broker peace in late 1945, and a ceasefire was announced in January 1946. But neither side trusted the other. Skirmishes in Manchuria never really stopped, and both armies kept moving troops into key positions. By mid‑1946, the truce had collapsed, and the struggle over post‑war territory had clearly turned into a full civil war.
                </p>
            </div>

            <div class="content-box p-7 bg-white rounded-xl border border-nhd-blue/30 mt-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Revolution, Reaction, and Reform</h2>
                <p class="text-gray-700 leading-relaxed">
                    This phase shows how ending a foreign war did not bring peace to China. The KMT reacted by using foreign transport and firepower to reclaim cities, hoping to finish its national revolution from the 1920s. The CCP instead deepened land and rent reforms in the countryside, winning peasant support. Those early choices about where to govern and whom to help set the stage for all the later phases of the civil war.
                </p>
            </div>
            
            <div class="pt-4 border-t border-gray-200">
                <label for="prompt-input" class="block text-lg font-bold text-gray-800 mb-2">Dive Deeper: Research a Historical Term</label>
                <p class="text-sm text-gray-600 mb-3">Ask about specific events or figures (e.g., "What was the Marshall Mission?" or "Describe the Soviet role in Manchuria").</p>
                <textarea id="prompt-input" placeholder="Enter your historical question here..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-nhd-blue focus:border-nhd-blue transition duration-150 h-24 resize-none"></textarea>
            </div>

            <div id="results-output" class="hidden mt-4 p-4 rounded-xl border-2 border-nhd-gold/50 bg-nhd-gold/10">
                <h3 class="text-md font-extrabold text-nhd-blue mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21 12 13.5H3.75z" />
                    </svg>
                    AI Research Result
                </h3>
            </div>
            
            <div id="loading-indicator" class="hidden flex justify-center items-center py-4">
                <div class="spinner"></div>
                <span class="ml-3 text-nhd-blue font-medium">Generating Answer...</span>
            </div>

            <button id="search-button"
                class="w-full nhd-blue hover:bg-nhd-blue/90 text-white font-bold py-3 px-4 rounded-xl transition duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center space-x-2"
                onclick="fetchHistoricalData()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                <span>Run Historical Search</span>
        </div>
    </div>
    
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-nhd-blue mb-3">Notice</h3>
            <p id="message-content" class="text-gray-700"></p>
            <button class="mt-4 w-full nhd-blue text-white py-2 rounded-lg hover:bg-blue-800 transition" 
                    onclick="document.getElementById('message-box').classList.add('hidden'); document.getElementById('message-box').classList.remove('flex');">
                Close
            </button>
        </div>
    </div>

    <script>
        // NOTE: The __app_id, __firebase_config, and __initial_auth_token are provided automatically by the environment.
        // For production (Vercel), the Gemini API key is stored in the GEMINI_API_KEY environment variable
        // and used via the /api/gemini serverless function, so it never appears in client-side JavaScript.
        const apiUrl = "/api/gemini";

        // Custom message box function to comply with the no-alert rule
        function showCustomMessage(message, title = 'Notice') {
            const msgBox = document.getElementById('message-box');
            document.querySelector('#message-box h3').textContent = title;
            document.getElementById('message-content').innerHTML = message;
            msgBox.classList.remove('hidden');
            msgBox.classList.add('flex');
        }

        async function fetchHistoricalData(retryCount = 0) {
            const prompt = document.getElementById('prompt-input').value.trim();
            const resultsOutput = document.getElementById('results-output');
            const loadingIndicator = document.getElementById('loading-indicator');
            const searchButton = document.getElementById('search-button');
            const maxRetries = 3;

            if (!prompt) {
                showCustomMessage('Please enter a term or question to search.', 'Input Required');
                return;
            }

            // UI updates for loading state
            resultsOutput.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            searchButton.disabled = true;
            searchButton.innerHTML = '<div class="spinner !border-l-white"></div><span class="ml-3">Searching...</span>';

            const payload = { prompt };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retryCount < maxRetries) {
                    // Exponential backoff
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchHistoricalData(retryCount + 1);
                }

                if (!response.ok) {
                    // Try to read detailed error from the API response body
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) {
                            errorMessage += ` - ${errorData.error}`;
                        }
                    } catch (e) {
                        // Ignore JSON parsing errors and fall back to basic message
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                let outputText = "<p class='text-gray-700'>No information found. Please try a different query.</p>";
                let sourcesHtml = "";

                if (result && result.text) {
                    const text = result.text;

                    if (Array.isArray(result.sources) && result.sources.length > 0) {
                        sourcesHtml = '<p class="text-xs font-semibold text-gray-600 mt-3 mb-1">Sources:</p><ul class="list-disc pl-5 text-xs text-gray-600 space-y-1">';
                        result.sources.forEach((source) => {
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="hover:underline text-nhd-blue">${source.title}</a></li>`;
                        });
                        sourcesHtml += '</ul>';
                    }

                    outputText = `<p class="text-gray-800 font-medium">${text}</p>${sourcesHtml}`;
                }

                resultsOutput.innerHTML = outputText;
                resultsOutput.classList.remove('hidden');

            } catch (error) {
                console.error("Gemini API Error:", error);
                showCustomMessage(`An error occurred while fetching data: <code>${error.message}</code>`, 'API Error');
            } finally {
                // UI updates for completion
                loadingIndicator.classList.add('hidden');
                searchButton.disabled = false;
                searchButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                          </svg>
                                          <span>Run Historical Search</span>`;
            }
        }
    </script>

</body>
</html>
